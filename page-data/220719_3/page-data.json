{"componentChunkName":"component---src-templates-post-template-tsx","path":"/220719_3/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h3>1. 문제 제기</h3>\n<p>프로그램을 작성 중, 파이썬 라이브러리를 사용해서 딥러닝 관련 응답을 받아와야 할 일이 생겼다.\r\nNodeJS는 기본적으로 다른 확장자의 파일을 실행할 수 있는 기능을 라이브러리로 제공한다.\r\n따라서 라이브러리를 사용하지 않는(혹은 pip로 설치하지 않는 라이브러리만 사용하는) 경우는 간단하게 파이썬을 실행시켜 결과값을\r\n가져올 수 있다.\r\n하지만 그렇지 않다면…? 딥러닝은 수많은 라이브러리를 사용하는데? python venv설정은? NodeJS와 연동이 되나?\r\n이러한 궁금증을 바탕으로, 그냥 한 번 악으로 깡으로 해보기로 했다.</p>\n<h3>2. 첫 번째 방법 : Child.spawn()을 이용해 파이썬 파일 실행 (실패)</h3>\n<p>첫 번째는 기본적인 NodeJS라이브러리를 활용하여 python 파일을 실행시키는 경우다. 거두절미하고 코드부터 봐보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">const express = require(\"express\");\r\nconst cors = require(\"cors\");\r\nconst app = express();\r\nconst bodyPaser = require(\"body-parser\");\r\nconst axios = require(\"axios\");\r\nconst helmet = require(\"helmet\");\r\nconst spawn = require('child_process').spawn;\r\n\r\napp.use(helmet());\r\napp.use(cors());\r\napp.use(bodyPaser.json());\r\napp.post(\"/message\", async (req, res) => {\r\n  try {\r\n    const message = req.body.info || \"Null\";\r\n    if (message == \"Null\") {\r\n      res.send(\"메세지를 정확히 입력해주세요!\");\r\n    } else {\r\n        //파이썬 코드를 child.spawn()로 실행해준다. stdout.on으로 파이썬 프로그램에서 뭔가를 출력(print)한다면 그걸 캐치해서 가져온다. \r\n      const result = spawn('python', ['main.py', '매개변수1']);\r\n      const data = result.stdout.on('data', function(data) {\r\n    console.log(data.toString());\r\n    });\r\n      res.send(data);\r\n    }\r\n  } catch (e) {\r\n    res.send(e);\r\n  }\r\n});\r\n\r\napp.listen(8080, () => {\r\n  console.log(\"App Started\");\r\n});</code></pre></div>\n<p>역시 실행이 되지 않는다. (파이썬에서 문장을 넘겨 그것을 분석하여 문장에 대한 answer을 print하는 코드를 작성하였다.)</p>\n<p>오류를 보자면, 첫 번째로 라이브러리 호출도 되지 않고, python 함수 내에서 pandas로 읽어오는 .csv 파일 또한\r\n경로가 확인되지 않는다는, 이상한 오류가 뜬다. 사실 VS Code로 실행해서 (평소에는 PyCharm 사용) 내가 venv 설정이라던지,\r\n라이브러리 설정을 잘못 한 것일 수도 있지만, 일단 venv도 설정해보고, 라이브러리도 새로 설치해보고 해봤지만, 실행이 잘 되지 않는다.\r\n결정적으로 무슨 이유에서인지 csv파일을 읽어오지 못한다. 아마 pandas 라이브러리가 제대로 호출되지 않아서 그런 듯 싶다.</p>\n<p>PyCharm으로 NodeJS가 아닌 파이썬 코드만 실행시키면 물론 작동이 된다! 하지만 NodeJS 서버에서 파이썬의 결과값을 불러올 수 없다면 어차피\r\n무용지물이기에 깔끔하게 포기. 왜 안된건진 추후에 리팩토링 해보고 이유 적어보도록 하겠다 :)</p>\n<h3>3. 두 번쨰 방법 : Python Flask 간이 서버를 만들어 처리 (성공)</h3>\n<p>두 번째 방법으로는, 그냥 파이썬 Flask 서버를 하나 여는것이다. 어차피 지금 만드는 웹 애플리케이션은 두 개 정도의 요청을 제외하고는\r\n파이썬 코드를 실행시킬 일이 없다. 그냥 간단한 라우터 두 개만 넣어서 서버를 실행시켜놓고, 요청 오면 전달해주면 되지 않을까? 라는 생각이었고,\r\n사실 생각이라기보단 이게 안 될 리가 없다. 이건 그냥 따로 파이썬을 실행시키는 방법이니…</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">const express = require(\"express\");\r\nconst cors = require(\"cors\");\r\nconst app = express();\r\nconst bodyPaser = require(\"body-parser\");\r\nconst axios = require(\"axios\");\r\nconst helmet = require(\"helmet\");\r\n\r\napp.use(helmet());\r\napp.use(cors());\r\napp.use(bodyPaser.json());\r\napp.post(\"/message\", async (req, res) => {\r\n  try {\r\n    const message = req.body.info || \"Null\";\r\n    if (message == \"Null\") {\r\n      res.send(\"메세지를 정확히 입력해주세요!\");\r\n    } else {\r\n        //파이썬 서버 주소인 5000번 포트로 요청을 전달해준다.\r\n      const result = await axios.post(\"http://localhost:5000\", {\r\n        info: message,\r\n      });\r\n      res.send(result.data);\r\n    }\r\n  } catch (e) {\r\n    res.send(e);\r\n  }\r\n});\r\n\r\napp.listen(8080, () => {\r\n  console.log(\"App Started\");\r\n});</code></pre></div>\n<p>파이썬 코드</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import pandas as pd\r\nfrom sentence_transformers import SentenceTransformer\r\nfrom sklearn.metrics.pairwise import cosine_similarity\r\nimport json\r\nfrom flask import Flask, request\r\n\r\napp = Flask(__name__)\r\n\r\ndef cached_model():\r\n    model = SentenceTransformer('jhgan/ko-sroberta-multitask')\r\n    return model\r\n\r\ndef get_dataset():\r\n    df = pd.read_csv('wellness_dataset.csv')\r\n    df['embedding'] = df['embedding'].apply(json.loads)\r\n    return df\r\ndef result(value) :\r\n    model = cached_model()\r\n    df = get_dataset()\r\n    user_input = value\r\n    embedding = model.encode(user_input)\r\n    df['distance'] = df['embedding'].map(lambda x: cosine_similarity([embedding], [x]).squeeze())\r\n    answer = df.loc[df['distance'].idxmax()]\r\n    return answer['챗봇']\r\n\r\n@app.route('/', methods=['GET','POST'])\r\ndef request_main():\r\n    value = request.json['info']\r\n    abc = result(value)\r\n    return abc\r\n    //1번에서는 여기가 print(abc)였다! 물론 flask 코드도 없었다.\r\n\r\nif __name__ == '__main__':\r\n    app.run()\r\n</code></pre></div>\n<p>이건 역시나 에러없이 한번에 성공, 물론 귀찮은 점은 (로컬에서 실행할 땐) IDE 두 개 켜놓고 하나는 Flask 하나는 NodeJS React 실행시켜야 한 다는 점이긴 하지만,\r\n솔직히 이게 가장 효율적이고 정석적인 방법이 아닐까 싶다.</p>\n<h3>4. 결론</h3>\n<p>분명히 간단한 코드라면 NodeJS상에서 바로 다른 확장자의 파일을 실행시켜도 되겠지만, 딥러닝처럼 복잡한 로직과\r\n많은 라이브러리를 활용하는 함수의 경우에는 그냥 Flask서버를 하나 만들어 NodeJS서버와 통신을 시키거나, 클라이언트에서 직접 통신을 받거나\r\n하는 편이 더 나은 것 같다. 실제로 엘리스 마지막 프로젝트에서 AI를 활용할때도 Flask서버를 따로 만들어 NginX 위에서 가동시켰었고.</p>\n<hr>\n<h2>Source</h2>\n<ul>\n<li>My Brain</li>\n</ul>","frontmatter":{"title":"NodeJS에서 파이썬 코드 실행하는 법","summary":"NodeJS 서버에서 파이썬 코드로 응답을 받아보자! 라이브러리 사용 X","date":"2022.07.19.","categories":["back","KOR"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wgARCAANABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAACAAGCf/EABYBAQEBAAAAAAAAAAAAAAAAAAcGCP/aAAwDAQACEAMQAAAB5lNIhL1gz8JLD0anf//EABwQAAICAgMAAAAAAAAAAAAAAAIFAwQBBgAHE//aAAgBAQABBQJOgvyTdjor8qkFds8ajgrbTY8myVe8o8//xAAjEQACAQIEBwAAAAAAAAAAAAABAgMEEgUGETEAEyEiIzJB/9oACAEDAQE/AczYpXQZlwxIZY1p47DXKIho3NVWFy6FpPERdYR2kL1ItCoxVTdD6rvTgnYfdeP/xAAiEQACAAUDBQAAAAAAAAAAAAABAgMEERMhBSIxABIjQ1H/2gAIAQIBAT8B0eDIvpUzcgFoxMWwxarDBXY1Rb8mcg8VxXuJK1O1+T7D96//xAAoEAACAgEDAgQHAAAAAAAAAAABAgMRBBITIQAiFCQxMgUGM0FCUbH/2gAIAQEABj8CggrEhhkjbfc7SPpilji3EGv6utwa2y3Hoyg18vucf4DAcfE8Z5TAx8LxWSy7TtlNFkSNMu1FqiB2FEs0jbfsHV+QRruVQkfEh7m9Wf8AY/I8c30sksjEYUOOSp7t98iNHJdmJoLpACqL49326hxpXK3jq8bgLcLdw7VoBlrgq9/yhGHI27iJHGsxsV11zVgDizXpfX//xAAbEAEBAAMAAwAAAAAAAAAAAAABEQAhMUFRcf/aAAgBAQABPyEfEiIiXEOmNYLsU7rtNyIFhp02WG9BJrkZI53RsXL9CqfdWu4oZMDNW/eyBGSqDsVYh8EatpnxiwpM/9oADAMBAAIAAwAAABBkP//EABgRAQEBAQEAAAAAAAAAAAAAAAERITEA/9oACAEDAQE/ED0uYdwSA3apP9dQadJsqS1qVWOtM//EABgRAQEBAQEAAAAAAAAAAAAAABEBIQBB/9oACAECAQE/EKk2KQAwBkBKXwkOsaZYLIQkJCkFPH//xAAXEAEBAQEAAAAAAAAAAAAAAAABEQAh/9oACAEBAAE/EEfVUmSCb/UiqdqhSBkBYOjpOXdprSD05DZIw3NE4BGnENQIKcQBLWeybAbUVcmxUvbJFHE4w7//2Q=="},"images":{"fallback":{"src":"/static/1d9174fba34894f84e8b8646343400f4/1c501/BackEnd.jpg","srcSet":"/static/1d9174fba34894f84e8b8646343400f4/d3f9e/BackEnd.jpg 70w,\n/static/1d9174fba34894f84e8b8646343400f4/1201d/BackEnd.jpg 140w,\n/static/1d9174fba34894f84e8b8646343400f4/1c501/BackEnd.jpg 279w","sizes":"(min-width: 279px) 279px, 100vw"},"sources":[{"srcSet":"/static/1d9174fba34894f84e8b8646343400f4/f7934/BackEnd.webp 70w,\n/static/1d9174fba34894f84e8b8646343400f4/9e59e/BackEnd.webp 140w,\n/static/1d9174fba34894f84e8b8646343400f4/2017a/BackEnd.webp 279w","type":"image/webp","sizes":"(min-width: 279px) 279px, 100vw"}]},"width":279,"height":180}},"publicURL":"/static/1d9174fba34894f84e8b8646343400f4/BackEnd.jpg"}}}}]}},"pageContext":{"slug":"/220719_3/"}},"staticQueryHashes":[]}